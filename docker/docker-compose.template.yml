version: '3.4'

services:
  blog:
    image: nkonev/blog:latest
    logging:
      driver: "json-file"
#      options:
#        tag: blog
    deploy:
      replicas: 2
      labels:
        - traefik.enable=true
        - traefik.backend=blog
        - traefik.frontend.rule=PathPrefix:/;Host:blog.test
        - traefik.port=8098
        - traefik.docker.network=proxy_backend
    environment:
      # https://stackoverflow.com/questions/28327620/difference-between-java-options-java-tool-options-and-java-opts
      # https://blogs.oracle.com/poonam/about-g1-garbage-collector%2c-permanent-generation-and-metaspace
      - _JAVA_OPTIONS=-Djava.security.egd=file:/dev/./urandom -Xms256m -Xmx512m -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=256M -XX:OnOutOfMemoryError="kill -9 %p"
      - liquibase.contexts=main,test
      - server.port=8098
      - custom.stomp.broker.host=rabbitmq
      - custom.stomp.broker.port=61613
      - spring.datasource.url=jdbc:postgresql://postgresql:5432/blog?connectTimeout=10&socketTimeout=40
      - spring.redis.url=redis://redis:6379/0
      - spring.resources.static-locations=file:/opt/blog/www/, classpath:/static/
      - custom.prerender.enable=true
      - custom.prerender.prerenderServiceUrl=http://prerender:3000/
      - custom.prerender.crawlerUserAgents=googlebot,prometheus
      - custom.prerender.forwardedURLHeader=X-FORWARDED-URL # only for tests
#      - logging.level.com.github.greengerong.PrerenderSeoService=TRACE
      - spring.mail.host=smtp.yandex.ru
      - custom.email.from=username@yandex.ru
      - spring.mail.username=username
      - spring.mail.password=password
      - custom.base-url=http://your-host.com
      - management.health.mail.enabled=false
    volumes :
      - ./www:/opt/blog/www
    ports:
      - 8098:8098
      - 3020:3010
    networks:
      - traefik_backend
      - backend
  traefik:
    image: traefik:1.5
    hostname: traefik
    command: -c /traefik.toml
    ports:
      - "8088:80"
      - "10000:8080"
      - "8445:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik/traefik.toml:/traefik.toml
#      - /dev/null:/traefik.toml
      - ./traefik/acme.json:/acme.json
    depends_on:
      - blog
    logging:
      driver: "json-file"
#      options:
#        tag: traefik
    networks:
      - traefik_backend
      - backend
  visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - 8092:8080
    stop_grace_period: 1m30s
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    logging:
      driver: "json-file"
#      options:
#        tag: visualizer
    deploy:
      placement:
        constraints: [node.role == manager]
    networks:
      - traefik_backend
      - backend
  postgresql:
    image: postgres:10.1
    hostname: postgresql
    environment:
      - POSTGRES_PASSWORD=postgresqlPassword
    volumes :
      - ./postgresql_prod/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
      - postgresql_prod_data_dir:/var/lib/postgresql/data
    logging:
      driver: "json-file"
#      options:
#        tag: postgresql
    deploy:
      placement:
        constraints: [node.labels.blog.server.role == db]
    networks:
      - traefik_backend
      - backend
  redis:
    image: redis:4.0.6
    hostname: redis
    volumes :
      - redis_prod_data_dir:/data
    logging:
      driver: "json-file"
#      options:
#        tag: redis
    deploy:
      placement:
        constraints: [node.labels.blog.server.role == db]
    networks:
      - traefik_backend
      - backend
  rabbitmq:
    image: nkonev/rabbitmq-web-stomp:3.7.2
    hostname: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=blog
      - RABBITMQ_DEFAULT_PASS=blogPazZw0rd
      - RABBITMQ_NODENAME=my-rabbit
    volumes :
      - rabbitmq_prod_data_dir:/var/lib/rabbitmq/mnesia
    logging:
      driver: "json-file"
#      options:
#        tag: rabbitmq
    deploy:
      placement:
        constraints: [node.labels.blog.server.role == db]
    networks:
      - traefik_backend
      - backend
  prerender:
    image: nkonev/prerender-redis
    hostname: prerender
    volumes:
      - redis_prerender_prod_data_dir:/var/lib/redis
    logging:
      driver: "json-file"
#      options:
#        tag: prerender
    deploy:
      placement:
        constraints: [node.labels.blog.server.role == db]
    networks:
      - traefik_backend
      - backend
  rabbitmq_exporter:
    image: kbudde/rabbitmq-exporter
    hostname: rabbitmq_exporter
    ports:
      - 9191:9191
    environment:
      - RABBIT_URL=http://rabbitmq:15672
      - RABBIT_USER=blog
      - RABBIT_PASSWORD=blogPazZw0rd
      - PUBLISH_PORT=9191
    logging:
      driver: "json-file"
#      options:
#        tag: rabbitmq_exporter
    networks:
      - traefik_backend
      - backend
  postgresql_exporter:
    image: wrouesnel/postgres_exporter
    hostname: postgresql_exporter
    ports:
      - 9187:9187
    volumes:
      - ./postgresql_exporter/queries.yaml:/queries.yaml
    environment:
      - DATA_SOURCE_NAME=postgresql://postgres:postgresqlPassword@postgresql:5432/blog?sslmode=disable
    command: ["--extend.query-path", "/queries.yaml"]
    logging:
      driver: "json-file"
#      options:
#        tag: postgresql_exporter
    networks:
      - traefik_backend
      - backend
  redis_exporter:
    image: oliver006/redis_exporter
    hostname: redis_exporter
    ports:
      - 9121:9121
    environment:
      - REDIS_ADDR=redis://redis:6379
    logging:
      driver: "json-file"
#      options:
#        tag: redis_exporter
    networks:
      - traefik_backend
      - backend
  node_exporter:
    image: prom/node-exporter
    hostname: 'node_exporter'
    ports:
      - '9100:9100'
    command: ["--log.level", "fatal", "--log.format", "logger:stdout"]
    logging:
      driver: "json-file"
#      options:
#        tag: node_exporter
    networks:
      - traefik_backend
      - backend
  blackbox_exporter:
    image: prom/blackbox-exporter
    hostname: 'blackbox_exporter'
    ports:
      - '9115:9115'
    volumes:
      - ./blackbox_exporter/blackbox.yml:/config/blackbox.yml
    command: ['--config.file=/config/blackbox.yml']
    logging:
      driver: "json-file"
#      options:
#        tag: blackbox_exporter
    networks:
      - traefik_backend
      - backend
  prometheus:
    image: prom/prometheus
    hostname: prometheus
    ports:
      - 9090:9090
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./prometheus/alerting.yml:/etc/prometheus/alerting.yml
      - prometheus_data:/prometheus
    deploy:
      placement:
        constraints: [node.role == manager]
      labels:
        - traefik.enable=true
        - traefik.backend=prometheus
        - traefik.frontend.rule=PathPrefix:/;Host:prometheus.blog.test
        - traefik.port=9090
        - traefik.docker.network=proxy_backend
        - traefik.frontend.auth.basic=admin:$$apr1$$naLpVBK2$$beVtB2oo9bUZuNjkBHyeA1
    logging:
      driver: "json-file"
#      options:
#        tag: prometheus
    networks:
      - traefik_backend
      - backend

  grafana:
    image: grafana/grafana:3.1.1
    hostname: grafana
    environment:
      - GF_AUTH_BASIC_ENABLED=false
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SERVER_ROOT_URL=http://grafana
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - PROMETHEUS_URL=http://prometheus:9090
    ports:
      - "3000:3000"
    volumes:
      - grafana_data_prod_data_dir:/var/lib/grafana
      - ./grafana/entrypoint.sh:/custom-entrypoint.sh
    entrypoint: ["/custom-entrypoint.sh"]
    deploy:
      placement:
        constraints: [node.role == manager]
      labels:
        - traefik.enable=true
        - traefik.backend=grafana
        - traefik.frontend.rule=PathPrefix:/;Host:grafana.blog.test
        - traefik.port=3000
        - traefik.docker.network=proxy_backend
        - traefik.frontend.auth.basic=admin:$$apr1$$naLpVBK2$$beVtB2oo9bUZuNjkBHyeA1
    logging:
      driver: "json-file"
#      options:
#        tag: grafana
    networks:
      - traefik_backend
      - backend
volumes:
  #enviroment
  postgresql_prod_data_dir:
  redis_prod_data_dir:
  rabbitmq_prod_data_dir:
  redis_prerender_prod_data_dir:
  prometheus_data:
  grafana_data_prod_data_dir:

networks:
  backend:
    driver: overlay
  traefik_backend:
    external:
      name: proxy_backend        
